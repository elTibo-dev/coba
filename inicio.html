<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwZt_l3P9xBRrpa2811YXZWdlfeCO3naWbBIIXCA_u-lAOygIGvEPCny967FQsGL8pK/exec";
  const uid = new URLSearchParams(window.location.search).get("uid");

  const perfilLink = document.getElementById("perfil-link");
  const pinSection = document.getElementById("pin-section");
  const mensaje = document.getElementById("mensaje");

  // Siempre mostrar botón de perfil si hay UID
  if (uid) {
    perfilLink.href = `cliente.html?uid=${uid}`;
  } else {
    perfilLink.href = "#";
  }

  // Cargar nombre y links desde el sheet
  fetch(`${scriptUrl}?uid=${uid}`)
    .then(res => res.json())
    .then(data => {
      if (data.cliente?.nombre) {
        document.getElementById("nombre").innerText = data.cliente.nombre;
      }
      if (data.cafeteria) {
        if (data.cafeteria.instagram)
          document.getElementById("instagram-link").href = data.cafeteria.instagram;
        if (data.cafeteria.facebook)
          document.getElementById("facebook-link").href = data.cafeteria.facebook;
        if (data.cafeteria.whatsapp)
          document.getElementById("whatsapp-link").href = data.cafeteria.whatsapp;
      }
    });

  // Mostrar campo de PIN solo al hacer clic
  function mostrarPinInput() {
    pinSection.style.display = "block";
  }

  // Registrar visita
  function registrarVisita() {
    const pin = document.getElementById("pin").value.trim();

    if (!pin) {
      mensaje.innerText = "Por favor ingresa el PIN.";
      return;
    }

    fetch(`${scriptUrl}?uid=${uid}&accion=registrarVisita&pin=${encodeURIComponent(pin)}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          mensaje.innerText = "✅ Visita registrada correctamente.";
          pinSection.style.display = "none"; // Ocultamos campo y botón
        } else {
          mensaje.innerText = "❌ " + (data.mensaje || "Error al registrar visita.");
        }
      })
      .catch(() => {
        mensaje.innerText = "❌ Error de conexión.";
      });
  }

  window.mostrarPinInput = mostrarPinInput;
  window.registrarVisita = registrarVisita;
</script>
